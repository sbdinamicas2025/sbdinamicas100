<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SBDIN√ÅMICAS | Premium Edition</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #1e293b, #0f172a);
      color: #f1f5f9;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass-panel {
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 2rem;
      box-shadow: 0 25px 50px rgba(0,0,0,.5);
    }

    .glass-input {
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.15);
      color: white;
    }

    .scroll-grid {
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .scroll-grid::-webkit-scrollbar { width: 6px; }
    .scroll-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

    .state-available { background: rgba(255,255,255,0.12); border: 1px dashed rgba(255,255,255,0.25); }
    .state-reserved { background: rgba(234,179,8,.25); border: 1px solid #eab308; }
    .state-sold { background: rgba(34,197,94,.25); border: 1px solid #22c55e; }

    .pantallazo-mode { 
      background: #f3f4f6 !important; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      padding: 10px !important;
    }
    .pantallazo-mode .no-print { display: none !important; }
    .pantallazo-mode #printable { 
      background: white !important; 
      color: #111827 !important; 
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100% !important;
      max-height: 100% !important;
      border-radius: 0 !important;
      padding: 10px !important;
      margin: 0 !important;
      position: relative;
    }
    .pantallazo-mode .participant-name { 
      display: block !important;
      font-size: 7px !important;
      line-height: 1;
      text-align: center;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .pantallazo-mode .scroll-grid { 
      max-height: calc(100vh - 150px) !important;
      overflow: auto !important;
    }
    .pantallazo-mode .grid-number {
      font-size: 9px !important;
    }

    .watermark {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 4rem; 
      font-weight: 900; 
      color: rgba(0,0,0,.03); 
      pointer-events: none;
      z-index: 1;
    }

    /* Estilos para logos de pago */
    .payment-logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .nequi-logo {
      background: linear-gradient(135deg, #004C97, #0080FF);
      color: white;
    }
    
    .daviplata-logo {
      background: linear-gradient(135deg, #FF6B00, #FF8C00);
      color: white;
    }
    
    /* Ajuste para pantalla de 10x10 */
    .grid-10x10 {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
    }
    
    .grid-cell {
      aspect-ratio: 1;
      min-height: 0;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2px;
    }
    
    /* Bot√≥n de salir mejorado */
    .exit-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(239, 68, 68, 0.95);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Grid principal m√°s grande */
    .main-grid {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .normal-mode .grid-10x10 {
      gap: 6px;
    }
    
    .normal-mode .grid-cell {
      min-height: 50px;
    }
    
    .normal-mode .grid-number {
      font-size: 10px;
      font-weight: bold;
      position: absolute;
      top: 2px;
      left: 2px;
      opacity: 0.7;
    }
    
    .normal-mode .participant-name {
      font-size: 8px;
      line-height: 1;
      text-align: center;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      margin-top: 12px;
      padding: 0 2px;
    }
    
    /* Panel de login */
    .login-panel {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    /* Bot√≥n guardar cambios */
    .save-btn {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .save-btn:active {
      transform: translateY(0);
    }
    
    /* Optimizaci√≥n para m√≥vil */
    @media (max-width: 480px) {
      .grid-10x10 {
        gap: 3px;
      }
      
      #printable {
        padding: 8px !important;
      }
      
      .watermark {
        font-size: 3rem;
      }
      
      .normal-mode .grid-cell {
        min-height: 45px;
      }
      
      .normal-mode .grid-number {
        font-size: 9px;
      }
      
      .normal-mode .participant-name {
        font-size: 7px;
        -webkit-line-clamp: 2;
      }
      
      .login-panel {
        width: 90% !important;
        padding: 1.5rem !important;
      }
    }
    
    @media (min-width: 481px) and (max-width: 768px) {
      .normal-mode .grid-cell {
        min-height: 55px;
      }
      
      .normal-mode .participant-name {
        font-size: 9px;
        -webkit-line-clamp: 3;
      }
    }
  </style>
</head>

<body class="p-2 md:p-4 normal-mode">

<a id="whatsappBtn" href="#" target="_blank" class="no-print fixed bottom-6 right-6 w-16 h-16 bg-[#25d366] rounded-full flex items-center justify-center text-3xl shadow-2xl hover:scale-110 transition-all z-40 hidden">
  <svg width="35" height="35" fill="white" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.893-11.891 3.181 0 6.167 1.24 8.413 3.488 2.246 2.248 3.484 5.232 3.484 8.402 0 6.556-5.332 11.89-11.893 11.89-1.997 0-3.951-.5-5.688-1.448l-6.308 1.668zm6.29-3.41c1.574.933 3.103 1.403 4.66 1.403 5.396 0 9.786-4.391 9.786-9.786 0-5.392-4.385-9.783-9.78-9.783-2.617 0-5.08 1.018-6.931 2.87-1.85 1.851-2.868 4.315-2.868 6.913 0 1.706.467 3.374 1.35 4.83l-1.006 3.673 3.795-.997zm11.332-6.845c-.312-.156-1.848-.912-2.135-1.017-.286-.106-.495-.156-.704.156-.21.312-.806.989-.989 1.198-.182.208-.364.234-.676.078-.312-.156-1.318-.486-2.51-1.548-.928-.827-1.554-1.849-1.735-2.16-.182-.312-.02-.481.136-.636.141-.14.312-.364.468-.547.156-.182.208-.312.312-.52.104-.208.052-.39-.026-.547-.078-.156-.704-1.691-.963-2.316-.252-.61-.51-.527-.704-.537-.182-.01-.39-.01-.598-.01-.208 0-.547.078-.833.39-.286.312-1.094 1.067-1.094 2.603 0 1.536 1.12 3.02 1.275 3.228.156.208 2.205 3.367 5.341 4.726.745.323 1.327.516 1.78.66.748.238 1.43.205 1.968.124.6-.09 1.848-.755 2.11-1.485.26-.73.26-1.354.182-1.485-.078-.13-.286-.208-.598-.364z"/></svg>
</a>

<button onclick="handleAdminClick()" id="adminBtn" class="no-print fixed top-6 right-6 w-14 h-14 bg-white/10 hover:bg-white/20 backdrop-blur-xl rounded-full flex items-center justify-center text-2xl transition-all z-40">
  ‚öôÔ∏è
</button>

<!-- Panel de Login Integrado -->
<div id="loginPanel" class="no-print fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
  <div class="login-panel p-8 rounded-2xl w-full max-w-md">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-black text-white">üîê ADMIN LOGIN</h1>
      <button onclick="closeLogin()" class="text-3xl text-white/70 hover:text-white">√ó</button>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm text-slate-300 mb-2">Correo Electr√≥nico</label>
        <input type="email" id="loginEmail" 
               class="w-full glass-input p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="admin@ejemplo.com"
               value="admin@sbdinamicas.com">
      </div>
      
      <div>
        <label class="block text-sm text-slate-300 mb-2">Contrase√±a</label>
        <input type="password" id="loginPassword" 
               class="w-full glass-input p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
               value="admin123">
      </div>
      
      <button onclick="performLogin()" 
              class="w-full save-btn py-3 rounded-xl font-black mt-6">
        INICIAR SESI√ìN
      </button>
    </div>
    
    <div class="mt-4 text-center">
      <p class="text-xs text-slate-400 italic">
        Solo administradores autorizados
      </p>
    </div>
  </div>
</div>

<!-- Panel de Administraci√≥n -->
<div id="adminPanel" class="no-print fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
  <div class="glass-panel p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6 text-white">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-black">‚ö° ADMIN PANEL</h1>
        <span id="adminStatus" class="text-xs bg-green-500/20 text-green-400 px-3 py-1 rounded-full hidden">
          ‚úÖ Conectado
        </span>
      </div>
      <button onclick="toggleAdmin()" class="text-3xl hover:rotate-90 transition-transform">√ó</button>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <div>
        <label class="block text-sm text-slate-300 mb-2">T√≠tulo de la Din√°mica</label>
        <input id="title" oninput="markUnsaved()" class="glass-input p-3 rounded-xl w-full" value="DIN√ÅMICA EFECTIVO FLASH">
      </div>
      
      <div>
        <label class="block text-sm text-slate-300 mb-2">Premio Principal</label>
        <input id="prize" oninput="markUnsaved()" class="glass-input p-3 rounded-xl w-full" value="GANA $3.000.000">
      </div>
      
      <div>
        <label class="block text-sm text-slate-300 mb-2">Valor por N√∫mero</label>
        <input id="value" oninput="markUnsaved()" class="glass-input p-3 rounded-xl w-full" value="VALOR $60.000">
      </div>
      
      <div>
        <label class="block text-sm text-slate-300 mb-2">Fecha / Evento</label>
        <input id="date" oninput="markUnsaved()" class="glass-input p-3 rounded-xl w-full" value="CRUZ ROJA - DIC 2025">
      </div>
      
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-300 mb-2">Texto del Pie</label>
        <input id="footer" oninput="markUnsaved()" class="glass-input p-3 rounded-xl w-full" value="SE JUEGA con LAS DOS √öLTIMAS CIFRAS">
      </div>
    </div>

    <!-- Bot√≥n de Guardar Cambios -->
    <div class="mb-6">
      <button id="saveChangesBtn" onclick="saveChanges()" 
              class="save-btn w-full py-3 rounded-xl font-black opacity-50 cursor-not-allowed" disabled>
        üíæ GUARDAR CAMBIOS
      </button>
      <p id="saveStatus" class="text-xs text-slate-400 text-center mt-2 hidden">
        Cambios guardados exitosamente
      </p>
    </div>

    <div class="flex gap-4 mb-4">
      <button onclick="pantallazo()" class="flex-1 bg-white text-black font-black py-3 rounded-xl hover:bg-white/90 transition-colors">
        üì∏ PANTALLAZO
      </button>
      <button onclick="clearAll()" class="px-6 bg-red-500/20 text-red-400 rounded-xl font-bold hover:bg-red-500/30 transition-colors">
        üóëÔ∏è BORRAR TODO
      </button>
    </div>
    
    <div class="border-t border-white/10 pt-4">
      <button onclick="signOutAdmin()" class="w-full py-3 text-slate-400 text-sm hover:text-white transition-colors">
        üëã Cerrar Sesi√≥n Admin
      </button>
    </div>
  </div>
</div>

<div class="max-w-4xl mx-auto w-full">
  <div id="printable" class="glass-panel p-4 md:p-6 relative">
    <div class="text-center mb-4 md:mb-6">
      <h2 id="showTitle" class="text-2xl md:text-3xl font-black uppercase italic"></h2>
      <p id="showPrize" class="font-black text-blue-400 text-lg md:text-xl"></p>
      <p id="showValue" class="text-slate-400 text-sm md:text-base"></p>
    </div>

    <div class="relative main-grid scroll-grid">
      <div class="watermark">SB</div>
      <div id="grid" class="grid-10x10 relative z-10"></div>
    </div>

    <div class="mt-4 md:mt-6 mb-4 md:mb-6 text-center">
      <div id="participantPanel" class="no-print glass-panel p-4 md:p-6 mb-4 md:mb-6 hidden">
        <h3 class="font-black text-lg md:text-xl mb-4 text-center">üë§ DATOS DEL PARTICIPANTE</h3>
        <div class="grid md:grid-cols-2 gap-3 md:gap-4 mb-4">
          <input id="partName" class="glass-input p-3 rounded-xl" placeholder="Nombre" maxlength="30">
          <input id="partLastname" class="glass-input p-3 rounded-xl" placeholder="Apellido" maxlength="30">
          <input id="partPhone" class="glass-input p-3 rounded-xl" placeholder="Celular" maxlength="15" type="tel">
          <div class="glass-input p-3 rounded-xl flex items-center justify-center">
            <span class="text-slate-400">Seleccionados: </span>
            <span id="selectedCount" class="ml-2 font-black text-2xl text-blue-400">0</span>
          </div>
        </div>
        
        <!-- Botones de pago con logos -->
        <div class="mb-4">
          <p class="text-slate-400 mb-3 text-sm md:text-base">M√©todos de pago disponibles:</p>
          <div class="flex justify-center gap-4 md:gap-6">
            <div class="flex flex-col items-center">
              <div class="payment-logo nequi-logo">
                <span>N</span>
              </div>
              <span class="text-xs mt-1">Nequi</span>
            </div>
            <div class="flex flex-col items-center">
              <div class="payment-logo daviplata-logo">
                <span>D</span>
              </div>
              <span class="text-xs mt-1">Daviplata</span>
            </div>
          </div>
        </div>
        
        <div id="selectedNumbers" class="mt-4 flex flex-wrap gap-2 justify-center"></div>
        
        <!-- Solo bot√≥n de WhatsApp -->
        <div class="mt-6">
          <button id="whatsappDataBtn" onclick="sendWhatsappFromData()" class="w-full bg-[#25d366] text-white py-3 rounded-xl font-black flex items-center justify-center gap-2 hover:bg-[#1da851] transition-colors">
            <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.893-11.891 3.181 0 6.167 1.24 8.413 3.488 2.246 2.248 3.484 5.232 3.484 8.402 0 6.556-5.332 11.89-11.893 11.89-1.997 0-3.951-.5-5.688-1.448l-6.308 1.668zm6.29-3.41c1.574.933 3.103 1.403 4.66 1.403 5.396 0 9.786-4.391 9.786-9.786 0-5.392-4.385-9.783-9.78-9.783-2.617 0-5.08 1.018-6.931 2.87-1.85 1.851-2.868 4.315-2.868 6.913 0 1.706.467 3.374 1.35 4.83l-1.006 3.673 3.795-.997zm11.332-6.845c-.312-.156-1.848-.912-2.135-1.017-.286-.106-.495-.156-.704.156-.21.312-.806.989-.989 1.198-.182.208-.364.234-.676.078-.312-.156-1.318-.486-2.51-1.548-.928-.827-1.554-1.849-1.735-2.16-.182-.312-.02-.481.136-.636.141-.14.312-.364.468-.547.156-.182.208-.312.312-.52.104-.208.052-.39-.026-.547-.078-.156-.704-1.691-.963-2.316-.252-.61-.51-.527-.704-.537-.182-.01-.39-.01-.598-.01-.208 0-.547.078-.833.39-.286.312-1.094 1.067-1.094 2.603 0 1.536 1.12 3.02 1.275 3.228.156.208 2.205 3.367 5.341 4.726.745.323 1.327.516 1.78.66.748.238 1.43.205 1.968.124.6-.09 1.848-.755 2.11-1.485.26-.73.26-1.354.182-1.485-.078-.13-.286-.208-.598-.364z"/></svg>
            ENVIAR POR WHATSAPP
          </button>
        </div>
      </div>

      <p id="showFooter" class="font-black uppercase text-xs md:text-sm"></p>
      <p id="showDate" class="text-xs text-slate-400"></p>
    </div>
  </div>
</div>

<button id="exitShot" onclick="salirPantallazo()" class="exit-button px-6 py-3 rounded-xl hidden z-50 text-white font-bold shadow-lg hover:scale-105 transition-transform">
  ‚ùå SALIR
</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8j6OmhdGkyF_Jw0Fz88BG0fWuixnY-EY",
    authDomain: "sbdinamicas-2025.firebaseapp.com",
    projectId: "sbdinamicas-2025",
    storageBucket: "sbdinamicas-2025.firebasestorage.app",
    messagingSenderId: "465275725018",
    appId: "1:465275725018:web:9f58c09a23a74a419171e3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const docRef = doc(db, "rifas", "dinamica_flash");
  const MI_TELEFONO = "573215714548";

  let data = [];
  let selectedNums = [];
  let isSelecting = false;
  let currentUser = null;
  let unsavedChanges = false;
  const STATES = ['state-available','state-reserved','state-sold'];

  // --- AUTH LOGIC ---
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    document.getElementById('adminBtn').textContent = user ? "üõ°Ô∏è" : "‚öôÔ∏è";
    
    if (user) {
      document.getElementById('adminStatus').classList.remove('hidden');
      document.getElementById('loginPanel').classList.add('hidden');
      document.getElementById('loginPanel').classList.remove('flex');
    } else {
      document.getElementById('adminStatus').classList.add('hidden');
    }
  });

  window.handleAdminClick = async () => {
    if (!currentUser) {
      openLogin();
    } else { 
      toggleAdmin();
    }
  };

  window.openLogin = () => {
    document.getElementById('loginPanel').classList.remove('hidden');
    document.getElementById('loginPanel').classList.add('flex');
  };

  window.closeLogin = () => {
    document.getElementById('loginPanel').classList.add('hidden');
    document.getElementById('loginPanel').classList.remove('flex');
  };

  window.performLogin = async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!email || !password) {
      alert('Por favor ingresa correo y contrase√±a');
      return;
    }
    
    try {
      await signInWithEmailAndPassword(auth, email, password);
      closeLogin();
    } catch (error) {
      alert('Error de autenticaci√≥n: ' + error.message);
    }
  };

  window.signOutAdmin = () => {
    signOut(auth).then(() => {
      toggleAdmin();
      location.reload();
    });
  };

  // --- FUNCIONES DE GUARDADO ---
  window.markUnsaved = () => {
    if (currentUser) {
      unsavedChanges = true;
      const saveBtn = document.getElementById('saveChangesBtn');
      saveBtn.disabled = false;
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      saveBtn.classList.add('opacity-100', 'cursor-pointer');
    }
  };

  window.saveChanges = async () => {
    if (!currentUser) return;
    
    const saveBtn = document.getElementById('saveChangesBtn');
    const saveStatus = document.getElementById('saveStatus');
    
    try {
      saveBtn.disabled = true;
      saveBtn.innerHTML = '‚è≥ GUARDANDO...';
      
      await setDoc(docRef, { 
        data, 
        config: {
          title: document.getElementById('title').value,
          prize: document.getElementById('prize').value,
          value: document.getElementById('value').value,
          date: document.getElementById('date').value,
          footer: document.getElementById('footer').value
        }
      });
      
      unsavedChanges = false;
      saveBtn.innerHTML = 'üíæ GUARDAR CAMBIOS';
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      saveBtn.classList.remove('opacity-100', 'cursor-pointer');
      
      // Mostrar mensaje de √©xito
      saveStatus.classList.remove('hidden');
      setTimeout(() => {
        saveStatus.classList.add('hidden');
      }, 3000);
      
    } catch (error) {
      alert('Error al guardar: ' + error.message);
      saveBtn.disabled = false;
      saveBtn.innerHTML = 'üíæ GUARDAR CAMBIOS';
    }
  };

  // --- FIREBASE SYNC ---
  onSnapshot(docRef, (docSnap) => {
    if (docSnap.exists()) {
      const remote = docSnap.data();
      data = remote.data;
      if (remote.config) {
        document.getElementById('title').value = remote.config.title;
        document.getElementById('prize').value = remote.config.prize;
        document.getElementById('value').value = remote.config.value;
        document.getElementById('date').value = remote.config.date;
        document.getElementById('footer').value = remote.config.footer;
        
        updateHeader();
      }
      renderGrid();
    } else { initGrid(); }
  });

  function initGrid() {
    data = Array.from({length: 100}, (_, i) => ({ 
      number: i.toString().padStart(2,'0'), 
      participant: null, 
      state: 0 
    }));
    renderGrid();
  }

  // --- WHATSAPP LOGIC ---
  window.updateWhatsapp = () => {
    const btn = document.getElementById('whatsappBtn');
    if (selectedNums.length > 0 && !currentUser) {
      btn.classList.remove('hidden');
      const lista = selectedNums.map(idx => data[idx].number).sort().join(', ');
      const name = document.getElementById('partName').value || 'Cliente';
      const lastname = document.getElementById('partLastname').value || '';
      const phone = document.getElementById('partPhone').value || '';
      
      const fullName = `${name} ${lastname}`.trim();
      const info = fullName ? `\nNombre: ${fullName}` : '';
      const phoneInfo = phone ? `\nCelular: ${phone}` : '';
      
      const msg = `¬°Hola! Quiero reservar los n√∫meros: *${lista}*${info}${phoneInfo}\n\n¬øC√≥mo realizo el pago por Nequi o Daviplata?`;
      btn.href = `https://wa.me/${MI_TELEFONO}?text=${encodeURIComponent(msg)}`;
    } else { 
      btn.classList.add('hidden'); 
    }
  };

  // Nueva funci√≥n para enviar WhatsApp desde el panel de datos
  window.sendWhatsappFromData = () => {
    const name = document.getElementById('partName').value.trim();
    const lastname = document.getElementById('partLastname').value.trim();
    const phone = document.getElementById('partPhone').value.trim();
    
    if (selectedNums.length === 0) {
      alert('Por favor selecciona al menos un n√∫mero');
      return;
    }
    
    if (!name) {
      alert('Por favor ingresa tu nombre');
      return;
    }
    
    if (!phone) {
      alert('Por favor ingresa tu n√∫mero de celular');
      return;
    }
    
    const lista = selectedNums.map(idx => data[idx].number).sort().join(', ');
    const fullName = `${name} ${lastname}`.trim();
    
    const msg = `¬°Hola! Quiero reservar los n√∫meros: *${lista}*\n\nüìã MIS DATOS:\nNombre: ${fullName}\nCelular: ${phone}\n\n¬øC√≥mo realizo el pago por Nequi o Daviplata?`;
    const whatsappUrl = `https://wa.me/${MI_TELEFONO}?text=${encodeURIComponent(msg)}`;
    
    // Abrir WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // Limpiar selecci√≥n despu√©s de enviar
    cancelSelection();
  };

  // --- UI LOGIC ---
  window.updateHeader = () => {
    document.getElementById('showTitle').textContent = document.getElementById('title').value;
    document.getElementById('showPrize').textContent = document.getElementById('prize').value;
    document.getElementById('showValue').textContent = document.getElementById('value').value;
    document.getElementById('showFooter').textContent = document.getElementById('footer').value;
    document.getElementById('showDate').textContent = document.getElementById('date').value;
  };

  window.toggleAdmin = () => {
    const p = document.getElementById('adminPanel');
    p.classList.toggle('hidden'); 
    p.classList.toggle('flex');
  };

  window.toggleNumber = (index) => {
    if (!isSelecting) {
      isSelecting = true;
      document.getElementById('participantPanel').classList.remove('hidden');
    }
    const idx = selectedNums.indexOf(index);
    if (idx > -1) selectedNums.splice(idx, 1);
    else if (selectedNums.length < 10) selectedNums.push(index);
    
    updateSelectedDisplay();
    updateWhatsapp();
    renderGrid();
  };

  function updateSelectedDisplay() {
    document.getElementById('selectedCount').textContent = selectedNums.length;
    const container = document.getElementById('selectedNumbers');
    container.innerHTML = '';
    selectedNums.sort((a,b)=>a-b).forEach(idx => {
      const b = document.createElement('span');
      b.className = 'bg-blue-500 text-white px-3 py-1 rounded-lg font-bold text-sm';
      b.textContent = data[idx].number;
      container.appendChild(b);
    });
  }

  window.cancelSelection = () => {
    isSelecting = false;
    selectedNums = [];
    document.getElementById('participantPanel').classList.add('hidden');
    document.getElementById('partName').value = '';
    document.getElementById('partLastname').value = '';
    document.getElementById('partPhone').value = '';
    updateWhatsapp();
    renderGrid();
  };

  window.renderGrid = () => {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    data.forEach((item, index) => {
      const cell = document.createElement('div');
      const isSel = selectedNums.includes(index);
      cell.className = `grid-cell rounded-lg cursor-pointer relative transition-all ${STATES[item.state]} ${isSel ? 'ring-2 ring-blue-500' : ''}`;

      cell.onclick = () => {
        if (item.state === 2) return;
        if (item.state === 0 || (isSelecting && item.state === 1 && selectedNums.includes(index))) {
          toggleNumber(index);
        } else if (item.state === 1 && currentUser) {
          alert(`Participante: ${item.participant.name}\nCel: ${item.participant.phone}`);
        }
      };

      cell.ondblclick = async e => {
        e.stopPropagation();
        if (currentUser && item.state === 1) {
          if (confirm('¬øVendido?')) { 
            data[index].state = 2; 
            markUnsaved();
          }
        }
      };

      const name = item.participant ? item.participant.name.toUpperCase() : '';
      cell.innerHTML = `
        <span class="grid-number">${item.number}</span>
        <span class="participant-name">${name}</span>
      `;
      grid.appendChild(cell);
    });
  };

  window.clearAll = async () => {
    if (currentUser && confirm('¬øReiniciar todo?')) {
      data.forEach(i => { i.participant = null; i.state = 0; });
      markUnsaved();
    }
  };

  window.pantallazo = () => {
    document.body.classList.remove('normal-mode');
    document.body.classList.add('pantallazo-mode');
    document.getElementById('exitShot').classList.remove('hidden');
    
    // Ajustar el grid para pantallazo
    setTimeout(() => {
      const grid = document.getElementById('grid');
      grid.className = 'grid-10x10 relative z-10';
      
      // Re-renderizar para ajustar tama√±os
      renderGrid();
    }, 100);
  };

  window.salirPantallazo = () => {
    document.body.classList.remove('pantallazo-mode');
    document.body.classList.add('normal-mode');
    document.getElementById('exitShot').classList.add('hidden');
    
    // Re-renderizar para volver al modo normal
    setTimeout(() => {
      renderGrid();
    }, 100);
  };
  
  // Inicializar
  updateHeader();
</script>
</body>
</html>