<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SBDIN√ÅMICAS | Pro Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at top left, #1e293b, #0f172a); color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
    .glass-panel { background: rgba(255,255,255,0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; }
    .glass-input { background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.15); color: white; }
    
    .state-available { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.1); }
    .state-reserved { background: rgba(234,179,8,0.2); border: 1px solid #eab308; }
    .state-paid { background: rgba(147,51,234,0.3); border: 1px solid #9333ea; }
    
    .grid-container { max-height: 55vh; overflow-y: auto; padding: 10px; border-radius: 1rem; }
    .grid-10x10 { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
    .grid-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 42px; }
    .participant-name { font-size: 6px; text-align: center; line-height: 1; margin-top: 5px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-transform: uppercase; font-weight: bold; }

    /* MODO PANTALLAZO OPTIMIZADO */
    .pantallazo-mode { background: #0b1120 !important; padding: 0 !important; }
    .pantallazo-mode .no-print, .pantallazo-mode #adminBtn { display: none !important; }
    .pantallazo-mode .max-w-4xl { max-width: 100% !important; margin: 0 !important; padding: 10px !important; }
    .pantallazo-mode .grid-container { max-height: none !important; overflow: visible !important; padding: 0 !important; margin-bottom: 10px; }
    .pantallazo-mode .grid-10x10 { gap: 0 !important; border: 1px solid rgba(255,255,255,0.1); width: 100%; }
    .pantallazo-mode .grid-cell { border: 0.5px solid rgba(255,255,255,0.1); border-radius: 0 !important; min-height: 8.2vw !important; }
    
    .footer-info { display: none; }
    .pantallazo-mode .footer-info { display: block; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }

    .exit-pantallazo { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; background: #ef4444; color: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; font-size: 10px; }
    .pantallazo-mode .exit-pantallazo { display: block; }
  </style>
</head>
<body class="p-3">

<button onclick="handleAdminClick()" id="adminBtn" class="fixed top-4 right-4 w-12 h-12 bg-white/10 backdrop-blur-lg rounded-full z-50 flex items-center justify-center border border-white/20">‚öôÔ∏è</button>
<button onclick="salirPantallazo()" class="exit-pantallazo shadow-2xl uppercase">‚úï Salir de Vista Foto</button>

<div id="adminPanel" class="no-print fixed inset-0 bg-black/95 hidden z-[60] p-4 overflow-y-auto">
    <div class="max-w-4xl mx-auto bg-slate-900 border border-white/10 rounded-3xl p-6">
        
        <div id="loginForm" class="hidden">
            <h2 class="text-center text-xl font-black mb-6 italic text-blue-400">ACCESO PRIVADO</h2>
            <input type="email" id="email" class="w-full glass-input p-4 rounded-xl mb-4" placeholder="Correo">
            <input type="password" id="pass" class="w-full glass-input p-4 rounded-xl mb-6" placeholder="Contrase√±a">
            <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-xl font-black">ENTRAR</button>
            <button onclick="toggleAdmin()" class="w-full text-slate-500 mt-4 text-xs">CERRAR</button>
        </div>

        <div id="adminDashboard" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-blue-400 italic">ADMIN</h2>
                <button onclick="cerrarSesion()" class="bg-red-600/20 text-red-400 px-3 py-1 rounded-lg text-[10px] font-bold uppercase">Cerrar Sesi√≥n</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6 text-center">
                <div class="bg-white/5 p-3 rounded-xl border border-white/5"><p class="text-[9px] text-slate-400 uppercase">Ventas</p><p id="statCash" class="text-lg font-black text-green-400">$0</p></div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/5"><p class="text-[9px] text-slate-400 uppercase">Pagos</p><p id="statSold" class="text-lg font-black text-purple-400">0/100</p></div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/5"><p class="text-[9px] text-slate-400 uppercase">Reservas</p><p id="statReserved" class="text-lg font-black text-yellow-400">0</p></div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/5"><p class="text-[9px] text-slate-400 uppercase">Libres</p><p id="statFree" class="text-lg font-black text-blue-400">100</p></div>
            </div>

            <input type="text" id="adminSearch" oninput="updateParticipantsTable()" placeholder="üîç Buscar por nombre, n√∫mero o ciudad..." class="w-full glass-input p-3 rounded-xl mb-4 text-sm">
            
            <div class="overflow-x-auto mb-6 max-h-60 overflow-y-auto border border-white/10 rounded-xl">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-white/10 sticky top-0">
                        <tr><th class="p-2">N¬∞</th><th class="p-2">Info</th><th class="p-2 text-right">Estado / Acciones</th></tr>
                    </thead>
                    <tbody id="participantsList"></tbody>
                </table>
            </div>

            <button id="saveChangesBtn" onclick="saveChanges()" class="w-full bg-blue-600 py-4 rounded-xl font-black mb-4 opacity-50" disabled>üíæ GUARDAR CAMBIOS</button>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="pantallazo()" class="bg-white text-black py-3 rounded-xl font-extrabold text-xs">üì∏ MODO PANTALLAZO</button>
                <button onclick="clearAll()" class="bg-red-900/40 text-red-400 py-3 rounded-xl font-extrabold text-xs">üóëÔ∏è REINICIAR</button>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <input id="title" oninput="markUnsaved()" class="glass-input p-2 rounded text-[10px]" placeholder="T√≠tulo">
                <input id="prize" oninput="markUnsaved()" class="glass-input p-2 rounded text-[10px]" placeholder="Premio">
                <input id="value" oninput="markUnsaved()" class="glass-input p-2 rounded text-[10px]" type="number" placeholder="Precio $">
                <input id="date" oninput="markUnsaved()" class="glass-input p-2 rounded text-[10px]" placeholder="Fecha/Loter√≠a">
            </div>
        </div>
    </div>
</div>

<div class="max-w-4xl mx-auto">
    <div class="text-center mb-4 pt-4">
        <h1 id="showTitle" class="text-2xl md:text-5xl font-black uppercase italic tracking-tighter mb-1"></h1>
        <p id="showPrize" class="text-blue-400 font-black text-lg md:text-2xl uppercase tracking-widest"></p>
    </div>
    
    <div class="grid-container">
        <div id="grid" class="grid-10x10"></div>
    </div>

    <div class="footer-info">
        <p class="text-blue-400 font-black text-[10px] uppercase tracking-[0.2em] mb-1">Informaci√≥n del Sorteo</p>
        <p id="showDate" class="text-white font-medium text-[9px] opacity-80 uppercase"></p>
    </div>

    <div id="participantPanel" class="no-print glass-panel p-5 mt-6 hidden border border-blue-500/30 text-center">
        <p class="text-blue-400 font-black text-xs mb-4 uppercase italic">Reserva tus n√∫meros</p>
        <div class="grid grid-cols-1 gap-2 mb-4">
            <input id="partName" class="glass-input p-3 rounded-xl text-sm" placeholder="Nombre Completo">
            <div class="grid grid-cols-2 gap-2">
                <input id="partCity" class="glass-input p-3 rounded-xl text-sm" placeholder="Ciudad">
                <input id="partPhone" class="glass-input p-3 rounded-xl text-sm" placeholder="WhatsApp">
            </div>
        </div>
        <div id="selectedNumsDisplay" class="flex flex-wrap gap-2 justify-center mb-4"></div>
        <button onclick="sendWhatsapp()" class="w-full bg-[#25d366] py-4 rounded-xl font-black text-sm">RESERVAR AHORA</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC8j6OmhdGkyF_Jw0Fz88BG0fWuixnY-EY",
        authDomain: "sbdinamicas-2025.firebaseapp.com",
        projectId: "sbdinamicas-2025",
        storageBucket: "sbdinamicas-2025.firebasestorage.app",
        messagingSenderId: "465275725018",
        appId: "1:465275725018:web:9f58c09a23a74a419171e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const docRef = doc(db, "rifas", "dinamica_flash");
    const MI_PHONE = "573215714548";

    let data = [];
    let selected = [];

    onAuthStateChanged(auth, u => {
        if (u) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
        } else {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }
    });

    onSnapshot(docRef, s => {
        if(s.exists()){
            const r = s.data();
            data = r.data;
            if(r.config){
                ['title','prize','value','date'].forEach(k => {
                    if(document.getElementById(k)) document.getElementById(k).value = r.config[k];
                });
                updateUI();
            }
            render(); updateStats(); updateParticipantsTable();
        } else { init(); }
    });

    function init(){
        data = Array.from({length:100}, (_,i)=>({ number: i.toString().padStart(2,'0'), participant: null, state: 0 }));
        render();
    }

    window.login = () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        signInWithEmailAndPassword(auth, e, p).catch(() => alert("Error de acceso"));
    };

    window.cerrarSesion = () => signOut(auth);
    window.handleAdminClick = () => document.getElementById('adminPanel').classList.toggle('hidden');
    window.toggleAdmin = () => document.getElementById('adminPanel').classList.add('hidden');
    
    window.markUnsaved = () => {
        const b = document.getElementById('saveChangesBtn');
        b.disabled = false; b.classList.remove('opacity-50');
    };

    window.saveChanges = async () => {
        await setDoc(docRef, { data, config: {
            title: document.getElementById('title').value,
            prize: document.getElementById('prize').value,
            value: document.getElementById('value').value,
            date: document.getElementById('date').value
        }});
        document.getElementById('saveChangesBtn').disabled = true;
        document.getElementById('saveChangesBtn').classList.add('opacity-50');
    };

    function updateUI(){
        document.getElementById('showTitle').innerText = document.getElementById('title').value;
        document.getElementById('showPrize').innerText = document.getElementById('prize').value;
        document.getElementById('showDate').innerText = document.getElementById('date').value;
    }

    function updateStats(){
        const val = parseInt(document.getElementById('value').value) || 0;
        const paid = data.filter(d => d.state === 3).length;
        const res = data.filter(d => d.state === 1).length;
        document.getElementById('statCash').innerText = `$${(paid * val).toLocaleString()}`;
        document.getElementById('statSold').innerText = `${paid}/100`;
        document.getElementById('statReserved').innerText = res;
        document.getElementById('statFree').innerText = 100 - paid - res;
    }

    window.render = () => {
        const g = document.getElementById('grid');
        g.innerHTML = '';
        data.forEach((item, i) => {
            const div = document.createElement('div');
            const isS = selected.includes(i);
            div.className = `grid-cell cursor-pointer ${item.state === 3 ? 'state-paid' : item.state === 1 ? 'state-reserved' : 'state-available'} ${isS ? 'ring-2 ring-blue-400 scale-90' : ''}`;
            div.onclick = () => {
                if(item.state === 0 || isS) {
                    const p = selected.indexOf(i);
                    if(p > -1) selected.splice(p,1); else if(selected.length < 10) selected.push(i);
                    document.getElementById('participantPanel').classList.toggle('hidden', selected.length === 0);
                    renderSelected(); render();
                }
            };
            div.innerHTML = `<span class="font-black text-xs">${item.number}</span><span class="participant-name">${item.participant ? item.participant.name : ''}</span>`;
            g.appendChild(div);
        });
    };

    function renderSelected(){
        const d = document.getElementById('selectedNumsDisplay');
        d.innerHTML = '';
        selected.forEach(idx => {
            const s = document.createElement('span');
            s.className = "bg-blue-600 px-3 py-1 rounded-lg text-[10px] font-black";
            s.innerText = data[idx].number;
            d.appendChild(s);
        });
    }

    window.sendWhatsapp = () => {
        const n = document.getElementById('partName').value.trim();
        const p = document.getElementById('partPhone').value.trim();
        const c = document.getElementById('partCity').value.trim();
        const t = document.getElementById('showTitle').innerText;
        if(!n || !p || !c) return alert("Completa todos los campos");
        
        selected.forEach(idx => { 
            data[idx].participant = { name: n.toUpperCase(), city: c.toUpperCase(), phone: p }; 
            data[idx].state = 1; 
        });

        const nums = selected.map(idx => data[idx].number).sort().join(', ');
        
        // MENSAJE PROFESIONAL INTEGRADO
        const mensaje = `*SOLICITUD DE RESERVA - ${t.toUpperCase()}* üéüÔ∏è\n` +
                        `________________________________\n\n` +
                        `Buen d√≠a, deseo confirmar la reserva de mis n√∫meros:\n\n` +
                        `üî¢ *N√öMEROS:* ${nums}\n` +
                        `üë§ *PARTICIPANTE:* ${n.toUpperCase()}\n` +
                        `üìç *CIUDAD:* ${c.toUpperCase()}\n\n` +
                        `________________________________\n\n` +
                        `Por favor, me indica los m√©todos de pago disponibles para proceder con la validaci√≥n.\n\n` +
                        `¬°Muchas gracias!`;
        
        window.open(`https://wa.me/${MI_PHONE}?text=${encodeURIComponent(mensaje)}`, '_blank');
        selected = []; document.getElementById('participantPanel').classList.add('hidden');
        markUnsaved(); render();
    };

    window.updateParticipantsTable = () => {
        const query = document.getElementById('adminSearch').value.toLowerCase();
        const body = document.getElementById('participantsList');
        body.innerHTML = '';
        data.forEach((item, i) => {
            if(item.participant){
                if(!item.number.includes(query) && !item.participant.name.toLowerCase().includes(query) && !item.participant.city.toLowerCase().includes(query)) return;
                const tr = document.createElement('tr');
                tr.className = "border-b border-white/5";
                tr.innerHTML = `
                    <td class="p-2 font-black text-blue-400">${item.number}</td>
                    <td class="p-2">
                        <div class="font-bold uppercase">${item.participant.name}</div>
                        <div class="opacity-50 text-[8px]">${item.participant.city} | ${item.participant.phone}</div>
                    </td>
                    <td class="p-2 flex justify-end gap-1">
                        <button onclick="togglePaid(${i})" class="${item.state === 3 ? 'bg-purple-600' : 'bg-slate-700'} p-2 rounded">‚úÖ</button>
                        <button onclick="deleteRes(${i})" class="bg-red-900/40 text-red-400 p-2 rounded">üóëÔ∏è</button>
                    </td>`;
                body.appendChild(tr);
            }
        });
    };

    window.togglePaid = (i) => { 
        data[i].state = data[i].state === 3 ? 1 : 3; 
        markUnsaved(); render(); updateStats(); updateParticipantsTable(); 
    };
    
    window.deleteRes = (i) => { if(confirm("¬øLiberar n√∫mero?")) { data[i].participant = null; data[i].state = 0; markUnsaved(); render(); updateStats(); updateParticipantsTable(); } };
    window.pantallazo = () => { document.body.classList.add('pantallazo-mode'); toggleAdmin(); };
    window.salirPantallazo = () => { document.body.classList.remove('pantallazo-mode'); };
    window.clearAll = () => { if(confirm("¬øBORRAR TODO?")) { init(); markUnsaved(); } };
</script>
</body>
</html>
